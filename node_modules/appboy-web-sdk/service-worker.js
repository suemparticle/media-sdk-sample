/*
* Braze Web SDK v2.5.2
* (c) Braze, Inc. 2020 - http://braze.com
* License available at https://github.com/Appboy/appboy-web-sdk/blob/master/LICENSE
* Compiled on 2020-04-16
*/
'use strict';const h={J:function(a){var b="=".repeat((4-a.length%4)%4);a=(a+b).replace(/\-/g,"+").replace(/_/g,"/");a=atob(a);b=new Uint8Array(a.length);for(let d=0;d<a.length;++d)b[d]=a.charCodeAt(d);return b}};const l={H:()=>{const a=b=>{const d=(Math.random().toString(16)+"000000000").substr(2,8);return b?"-"+d.substr(0,4)+"-"+d.substr(4,4):d};return a()+a(!0)+a(!0)+a()}};function q(a){if("indexedDB"in a.B)return a.B.indexedDB}function r(a){try{if(null==q(a))return!1;q(a).open("Braze IndexedDB Support Test");if("undefined"!==typeof window){const b=window.ja||window.ia||window.la;if(b&&b.I&&b.I.id)return a.c.info("Not using IndexedDB for storage because we are running inside an extension"),!1}return!0}catch(b){return a.c.info("Not using IndexedDB for storage due to following error: "+b),!1}}
function t(a,b,d){const f=q(a).open(a.b.g,a.b.VERSION);if(null==f)return"function"===typeof d&&d(),!1;f.onupgradeneeded=e=>{a.c.info("Upgrading indexedDB "+a.b.g+" to v"+a.b.VERSION+"...");e=e.target.result;for(const c in a.b.f)a.b.f.hasOwnProperty(c)&&!e.objectStoreNames.contains(a.b.f[c])&&e.createObjectStore(a.b.f[c])};f.onsuccess=e=>{a.c.debug("Opened indexedDB "+a.b.g+" v"+a.b.VERSION);const c=e.target.result;c.onversionchange=()=>{c.close();"function"===typeof d&&d();a.c.error("Needed to close the database unexpectedly because of an upgrade in another tab")};
b(c)};f.onerror=e=>{a.c.info("Could not open indexedDB "+a.b.g+" v"+a.b.VERSION+": "+e.target.errorCode);"function"===typeof d&&d();return!0};return!0}
function v(a,b,d,f){r(a)?t(a,e=>{e.objectStoreNames.contains(b)?(e=e.transaction([b],"readonly").objectStore(b).openCursor(null,"prev"),e.onerror=()=>{a.c.error("Could not open cursor for "+b+" on indexedDB "+a.b.g);"function"===typeof f&&f()},e.onsuccess=c=>{c=c.target.result;null!=c&&null!=c.value&&null!=c.key?(a.c.debug("Retrieved last record "+c.key+" in "+b+" on indexedDB "+a.b.g),d(c.key,c.value)):"function"===typeof f&&f()}):(a.c.error("Could not retrieve last record from "+b+" on indexedDB "+
a.b.g+" - "+b+" is not a valid objectStore"),"function"===typeof f&&f())},f):"function"===typeof f&&f()}
class w{constructor(a,b){this.B="undefined"===typeof window?self:window;this.b=a;this.c=b}setItem(a,b,d,f,e){if(!r(this))return"function"===typeof e&&e(),!1;const c=this;return t(this,g=>{g.objectStoreNames.contains(a)?(g=g.transaction([a],"readwrite").objectStore(a).put(d,b),g.onerror=()=>{c.c.error("Could not store object "+b+" in "+a+" on indexedDB "+c.b.g);"function"===typeof e&&e()},g.onsuccess=()=>{c.c.debug("Stored object "+b+" in "+a+" on indexedDB "+c.b.g);"function"===typeof f&&f()}):(c.c.error("Could not store object "+
b+" in "+a+" on indexedDB "+c.b.g+" - "+a+" is not a valid objectStore"),"function"===typeof e&&e())},e)}getItem(a,b,d){if(!r(this))return!1;const f=this;return t(this,e=>{e.objectStoreNames.contains(a)?(e=e.transaction([a],"readonly").objectStore(a).get(b),e.onerror=()=>{f.c.error("Could not retrieve object "+b+" in "+a+" on indexedDB "+f.b.g)},e.onsuccess=c=>{f.c.debug("Retrieved object "+b+" in "+a+" on indexedDB "+f.b.g);c=c.target.result;null!=c&&d(c)}):f.c.error("Could not retrieve object "+
b+" in "+a+" on indexedDB "+f.b.g+" - "+a+" is not a valid objectStore")})}clearData(){if(!r(this))return!1;const a=[];for(const d in this.b.f)this.b.f.hasOwnProperty(d)&&this.b.f[d]!==this.b.f.v&&a.push(this.b.f[d]);const b=this;return t(this,function(d){d=d.transaction(a,"readwrite");for(let f=0;f<a.length;f++){const e=d.objectStore(a[f]).clear();e.onsuccess=function(){b.c.debug("Cleared "+this.source.name+" on indexedDB "+b.b.g)};e.onerror=function(){b.c.error("Could not clear "+this.source.name+
" on indexedDB "+b.b.g)}}d.oncomplete=function(){b.c.debug("Cleared all object stores on indexedDB "+b.b.g)};d.onerror=function(){b.c.error("Could not clear object stores on indexedDB "+b.b.g)}})}};const x={s:function(a){if(void 0!==a||void 0===x.j)x.j=!!a;x.A||(x.A=!0)},ka:function(){x.A=!1;x.j=void 0;x.c=void 0},ma:function(a){"function"!==typeof a?x.info("Ignoring setLogger call since logger is not a function"):(x.s(),x.c=a)},na:function(){x.s();x.j?(console.log("Disabling Appboy logging"),x.j=!1):(console.log("Enabled Appboy logging"),x.j=!0)},debug:function(a){x.j&&null!=x.c&&x.c("Appboy: "+a)},info:function(a){x.j&&(a="Appboy: "+a,null!=x.c?x.c(a):console.log(a))},error:function(a){x.j&&
(a="Appboy SDK Error: "+a+" (v2.5.2)",null!=x.c?x.c(a):console.error(a))}};var y={CustomEvent:"ce",aa:"p",G:"pc",F:"ca",ca:"i",ba:"ie",P:"cci",R:"ccic",N:"ccc",O:"ccd",ha:"ss",ga:"se",$:"si",Y:"sc",X:"sbc",Z:"sfe",S:"iec",fa:"lr",K:"uae",M:"ci",L:"cc",da:"lcaa",ea:"lcar",U:"inc",T:"add",V:"rem",W:"set"},z=w,A={h:{g:"AppboyServiceWorkerAsyncStorage",VERSION:5,f:{l:"data",D:"pushClicks",w:"pushSubscribed",o:"fallbackDevice",C:"cardUpdates",v:"optOut"},m:1}},B=x;function C(){return new Promise(function(a,b){const d=A.h;v(new z(d,B),d.f.v,b,a)})};function D(a,b,d){return new Promise(function(f,e){const c={};c.time=Math.floor((new Date).valueOf()/1E3);c.device_id=d;c.api_key=a;c.sdk_version="2.5.2";c.sdk_flavor="amp";c.respond_with={config:{config_time:0}};fetch(b+"/data/",{method:"POST",headers:{"Content-type":"application/json","X-Braze-Api-Key":a},body:JSON.stringify(c)}).then(function(g){g.ok||B.error("Unable to get config: "+g.status);return g.json()}).then(function(g){g.error?(B.error("Unable to get config: "+g.error),e()):
(g={userVisibleOnly:!0,applicationServerKey:h.J(g.config.vapid_public_key)},f(g))}).catch(function(g){B.error("Unable to get config: "+g);e()})})}
function H(a,b,d,f,e,c,g,k){return new Promise(function(m,n){const p={};p.device_id=d;p.api_key=a;p.sdk_version="2.5.2";null!=c&&(p.sdk_flavor=c);let E=null,F=null,G=null;e&&(G=e.endpoint,e.getKey&&(E=btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("p256dh")))),F=btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("auth"))))));p.time=Math.floor((new Date).valueOf()/1E3);p.attributes=[{user_id:f,push_token:G,custom_push_public_key:E,custom_push_user_auth:F}];fetch(b+"/data/",
{method:"POST",headers:{"Content-type":"application/json","X-Braze-Api-Key":p.api_key},body:JSON.stringify(p)}).then(function(u){u.ok||B.error(k+" "+u.status);return u.json()}).then(function(u){u.error?(B.error(k+" "+u.error),n()):(B.info(g),m())}).catch(function(u){B.error(k+" "+u);n()})})}
function I(a,b){return C().then(function(){const d=A.h;v(new z(d,B),d.f.l,function(f,e){f=Math.floor((new Date).valueOf()/1E3);const c=e.data;c.time=f;a.time=f;a.user_id=e.userId;c.events=[a];c.sdk_version="2.5.2";fetch(e.baseUrl+"/data/",{method:"POST",headers:{"Content-type":"application/json","X-Braze-Api-Key":c.api_key},body:JSON.stringify(c)}).then(function(g){g.ok||B.error("Unable to log "+b+": "+g.status);return g.json()}).then(function(g){g.error?B.error("Unable to log "+b+":",g.error):
B.info("Successfully logged "+b);return Promise.resolve()}).catch(function(g){B.error("Unable to log "+b+":",g);return Promise.resolve()})})}).catch(function(){return Promise.reject("Not sending data to Braze backend due to opt-out.")})};function J(){const a=self.location.search.match(/apiKey=([^&]+)/i);if(a)return a[1];B.error("Missing API key in query params.");return null}function K(){const a=self.location.search.match(/baseUrl=([^&]+)/i);if(a)return a[1];B.error("Missing base URL in query params.");return null};function L(a,b){self.clients.matchAll().then(function(d){for(let f=0;f<d.length;f++)d[f].postMessage({command:a,payload:b})})}
function M(a,b,d,f){return D(a,b,d).then(function(e){return self.registration.pushManager.subscribe(e)}).then(function(e){L("amp-web-push-subscribe",null);return H(a,b,d,f,e,"amp","Successfully sent AMP push subscription to Braze backend.","Unable to send AMP push subscription to Braze backend.")}).catch(function(){B.error("Failed to subscribe for AMP push.");return Promise.reject()})}
function N(){self.registration.pushManager.getSubscription().then(function(a){return a?self.registration.pushManager.permissionState(a.options):null}).then(function(a){L("amp-web-push-subscription-state","granted"===a)})}
function O(){const a=A.h,b=new z(a,B);return(new Promise(function(d,f){v(b,a.f.l,function(e,c){M(c.data.api_key,c.baseUrl,c.data.device_id,c.userId).then(function(){d()}).catch(function(){f()})},function(){const e=J(),c=K();v(b,a.f.o,function(g,k){M(e,c,k,null).then(function(){d()}).catch(function(){f()})},function(){const g=l.H();(new Promise(function(k,m){b.setItem(a.f.o,a.m,g,k,m)})).then(function(){return M(e,c,g,null)}).then(function(){d()}).catch(function(){f()})})})})).then(function(){return new Promise(function(d,
f){b.setItem(a.f.w,a.m,!0,d,f)})})}
function P(){return self.registration.pushManager.getSubscription().then(function(a){return a.unsubscribe()}).then(function(){L("amp-web-push-unsubscribe",null);const a=A.h,b=new z(a,B);return(new Promise(function(d,f){v(b,a.f.l,function(e,c){H(c.data.api_key,c.baseUrl,c.data.device_id,c.userId,null,"amp","Successfully sent AMP push unsubscription to Braze backend.","Unable to send AMP push unsubscription to Braze backend.").then(function(){d()}).catch(function(){f()})},function(){v(b,a.f.o,function(e,
c){e=J();const g=K();H(e,g,c,null,null,"amp","Successfully sent AMP push unsubscription to Braze backend.","Unable to send AMP push unsubscription to Braze backend.").then(function(){d()}).catch(function(){f()})},function(){B.error("No device found during unsubscription.");f()})})})).then(function(){return new Promise(function(d,f){b.setItem(a.f.w,a.m,!1,d,f)})})}).catch(function(){B.error("Failed to unsubscribe for AMP push.");return Promise.reject()})};function Q(a,b){a.waitUntil(b.catch(function(d){d&&B.info(d)}))};B.s(!0);
function R(a){if(null==a||0===Object.keys(a).length)return Promise.reject("Server has no pending push message for this registration. Ignoring push event.");const b=a.t,d=a.a,f=a.i,e=a.img,c={url:a.u,ab_ids:{cid:a.cid},extra:a.e},g=a.ri;a.ab_push_fetch_test_triggers_key&&(B.info("Service worker 2.5.2 found trigger fetch key in push payload."),c.fetchTriggers=!0);var k=a.ab_cd;if(null!=k){var m=A.h;(new z(m,B)).setItem(m.f.C,(new Date).valueOf(),{userId:a.ab_cd_uid,card:k})}a=a.pab||[];k=
{};for(m=0;m<a.length;m++)if(null!=a[m]&&null!=a[m].action){let n;switch(a[m].a){case "ab_none":n=null;break;case "ab_uri":if(n=a[m].u,null==n||""===n)n="/"}k[a[m].action]=n}c.actionTargets=k;B.info("Displaying push notification!");return self.registration.showNotification(b,{body:d,icon:f,image:e,data:c,actions:a,requireInteraction:g}).catch(function(n){B.info(n)})}self.addEventListener("install",function(a){a.waitUntil(self.skipWaiting())});self.addEventListener("activate",function(){return self.clients.claim()});
self.addEventListener("push",function(a){B.info("Service worker 2.5.2 received push");null!=a.data&&null!=a.data.json?Q(a,R(a.data.json())):Q(a,new Promise(function(b,d){const f=A.h;v(new z(f,B),f.f.l,function(e,c){const g=c.data;C().then(function(){return fetch(c.baseUrl+"/web_push/",{method:"POST",headers:{"Content-type":"application/json","X-Braze-Api-Key":g.api_key},body:JSON.stringify(g)})}).then(function(k){return k.ok?k.json():(B.error("Unable to retrieve push payload from server: "+
k.status),Promise.reject())}).then(function(k){B.info("Retrieved push payload from server");b(R(k))}).catch(function(k){d("Unable to retrieve push payload from server or user has opt-out: "+k)})})}))});
self.addEventListener("notificationclick",function(a){if(a&&a.notification&&(a.notification.close(),null!=Notification&&Notification.prototype.hasOwnProperty("data")&&a.notification.data&&a.notification.data.ab_ids)){var b=null!=a.action&&""!==a.action;var d=b?I({name:y.F,data:{cid:a.notification.data.ab_ids.cid,a:a.action}},"push button click"):I({name:y.G,data:{cid:a.notification.data.ab_ids.cid}},"push click");if(!b){const g={lastClick:(new Date).valueOf(),trackingString:a.notification.data.ab_ids.cid};
a.notification.data.fetchTriggers&&(g.fetchTriggers=!0);const k=A.h,m=new z(k,B);var f=d.then(function(){return new Promise(function(n,p){m.setItem(k.f.D,k.m,g,n,p)})}).catch(function(){B.info("Not storing push click due to no click event being created.");return Promise.resolve()})}if(b)var e=a.notification.data.actionTargets[a.action];else if(e=a.notification.data.url,null==e||""===e)e="/";var c;null!=e&&""!==e&&(c=clients.matchAll({type:"window"}).then(function(){if(clients.openWindow)return clients.openWindow(e)}));
Q(a,Promise.all([c,f]))}});self.addEventListener("pushsubscriptionchange",function(a){Q(a,C().then(function(){let b={userVisibleOnly:!0};null!=a.oldSubscription&&(b=a.oldSubscription.options);return self.registration.pushManager.subscribe(b)}).then(function(b){const d=A.h;return new Promise(function(f,e){v(new z(d,B),d.f.l,function(c,g){H(g.data.api_key,g.baseUrl,g.data.device_id,g.userId,b,null,"Successfully resubscribed user after expiration","Unable to resubscribe user").then(function(){f()}).catch(function(){e()})})})}).catch(function(){return Promise.reject("Not resubscribing user for push due to opt-out.")}))});
self.addEventListener("message",function(a){a.waitUntil&&a.data.command&&a.waitUntil(C().then(function(){switch(a.data.command){case "amp-web-push-subscription-state":return N(),Promise.resolve();case "amp-web-push-subscribe":return O();case "amp-web-push-unsubscribe":return P();default:return Promise.resolve()}}).catch(function(){B.info("Ignoring message from amp-web-push due to opt-out.");return Promise.resolve()}))});
